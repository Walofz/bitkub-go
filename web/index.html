<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitkub Rebalance Bot Status</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #007bff;
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        h3 {
            border-left: 5px solid #007bff;
            padding-left: 10px;
            margin-top: 30px;
            color: #444;
        }

        .status-box {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .status-box.production {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-box.dry-run {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: right;
        }

        .table th:first-child,
        .table td:first-child {
            text-align: left;
        }

        .table th {
            background-color: #007bff;
            color: white;
            font-weight: normal;
        }

        .control-panel button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .control-panel button.dry {
            background-color: #ffc107;
            color: #333;
        }

        .control-panel button.prod {
            background-color: #28a745;
            color: white;
        }

        .info-detail {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            text-align: left;
            margin-bottom: 15px;
        }

        .info-detail p {
            margin: 5px 0;
        }

        .roi-positive {
            color: green;
        }

        .roi-negative {
            color: red;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ü§ñ Bitkub Rebalance Bot Status</h1>

        <div class="status-box" id="mode-status-box">
            ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="mode-display">...</span>
        </div>

        <div class="info-detail">
            <p>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="last-run-display">--:--:--</span></p>
            <p style="font-weight: bold;">ETH ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="eth-price-display">...</span> THB</p>

            <hr style="border-top: 1px solid #ccc; margin: 10px 0;">

            <p style="font-size: 1.1em;">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏£‡∏ß‡∏°: <span id="total-value-display"
                    style="font-weight: bold;">...</span></p>
            <p style="font-size: 1.1em;">‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô (ROI): <span id="roi-display" style="font-weight: bold;">0.00%</span>
            </p>
        </div>

        <h3>üìà ‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÇ‡∏ü‡∏•‡∏¥‡πÇ‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</h3>

        <table class="table" id="balance-table">
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</th>
                    <th>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (THB Eq.)</th>
                    <th>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏£‡∏¥‡∏á</th>
                    <th>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th>
                </tr>
            </thead>
            <tbody id="balance-data">
                <tr>
                    <td colspan="5" style="text-align: center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
                </tr>
            </tbody>
        </table>

        <h3>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ö‡∏≠‡∏ó</h3>
        <div class="control-panel" style="text-align: center;">
            <button class="dry" onclick="toggleMode('dry')">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô DRY RUN</button>
            <button class="prod" onclick="toggleMode('prod')">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô PRODUCTION</button>
        </div>
    </div>

    <script>
        const modeDisplay = document.getElementById('mode-display');
        const modeStatusBox = document.getElementById('mode-status-box');
        const lastRunDisplay = document.getElementById('last-run-display');
        const ethPriceDisplay = document.getElementById('eth-price-display');
        const totalValueDisplay = document.getElementById('total-value-display');
        const roiDisplay = document.getElementById('roi-display');
        const balanceTableBody = document.getElementById('balance-data');

        const numberFormatter = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });

        const coinFormatter = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2, // ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠
            maximumFractionDigits: 8,
        });

        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                modeDisplay.textContent = data.mode;
                modeStatusBox.className = 'status-box ' + (data.mode === 'DRY_RUN' ? 'dry-run' : 'production');
                lastRunDisplay.textContent = data.last_run;

                ethPriceDisplay.textContent = numberFormatter.format(data.eth_price || 0);
                totalValueDisplay.textContent = numberFormatter.format(data.total_value || 0) + ' THB';

                const roiValue = data.roi || 0;
                roiDisplay.textContent = roiValue.toFixed(2) + '%';
                roiDisplay.className = roiValue >= 0 ? 'roi-positive' : 'roi-negative';

                balanceTableBody.innerHTML = '';

                if (Array.isArray(data.portfolio)) {
                    data.portfolio.forEach(asset => {
                        const row = balanceTableBody.insertRow();

                        const displayCoinBalance = asset.coin_balance || 0;
                        const displayBalanceTHB = asset.balance_thb || 0;
                        const displayActualPct = asset.actual_pct || 0;
                        const displayTargetPct = asset.target_pct || 0;

                        const deviation = Math.abs(displayActualPct - displayTargetPct);
                        let rowClass = deviation > 5 ? 'style="background-color: #fff3cd;"' : '';
                        row.setAttribute('style', rowClass);

                        row.insertCell().textContent = asset.asset;

                        let coinBalanceText = '';
                        if (asset.asset === 'THB') {
                            coinBalanceText = numberFormatter.format(displayCoinBalance);
                        } else {
                            coinBalanceText = coinFormatter.format(displayCoinBalance);
                        }
                        row.insertCell().textContent = coinBalanceText;

                        row.insertCell().textContent = numberFormatter.format(displayBalanceTHB);
                        row.insertCell().textContent = displayActualPct.toFixed(2) + '%';
                        row.insertCell().textContent = displayTargetPct.toFixed(2) + '%';
                    });
                } else {
                    const row = balanceTableBody.insertRow();
                    row.insertCell(0).textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÇ‡∏ü‡∏•‡∏¥‡πÇ‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
                    row.cells[0].colSpan = 5;
                }

            } catch (error) {
                console.error('Error fetching status:', error);
                const row = balanceTableBody.insertRow();
                row.insertCell(0).textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Go Backend ‡πÑ‡∏î‡πâ";
                row.cells[0].colSpan = 5;
                balanceTableBody.innerHTML = row.outerHTML;
            }
        }

        async function toggleMode(newMode) {
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô ${newMode.toUpperCase()}?`)) {
                try {
                    await fetch(`/api/mode/${newMode}`, { method: 'POST' });
                    fetchStatus();
                } catch (error) {
                    console.error('Error toggling mode:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î');
                }
            }
        }

        setInterval(fetchStatus, 5000);
        fetchStatus();
    </script>
</body>

</html>